<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pathfinder Dice Roller</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%2310b981'/%3E%3Ctext x='12' y='16' font-size='12' font-weight='700' text-anchor='middle' fill='white'%3Ed20%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel-2:#0b1220; --border:#1f2a3c; --text:#e2e8f0;
      --muted:#93a4b8; --accent:#10b981; --accent-2:#064e3b;
      --r-lg:20px; --shadow:0 10px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}

    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;-webkit-tap-highlight-color:transparent}

    .app{min-height:100%;display:flex;flex-direction:column}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .bar{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 12px}
    .title{margin:0;font-size:18px}

    main{flex:1;display:flex;flex-direction:column;gap:14px;padding:14px}
    section > .hint{font-size:13px;color:var(--muted);margin-bottom:8px;display:block}

    .dice-grid{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
    .dice-grid > .btn{scroll-snap-align:start}
    .dice-grid::-webkit-scrollbar{display:none}
    .dice-grid{scrollbar-width:none;-ms-overflow-style:none}
    .btn{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:12px;padding:12px 10px;font-size:16px;font-weight:700;text-align:center;outline:none;transition:.15s transform,.15s background,.15s border}
    .btn:active{transform:scale(.98)}
    .btn.active{background:var(--accent);color:#06241a;border-color:#0ea972}

    /* Controls layout: qty + mod compact on one line, presets take remaining space */
    .row{display:grid;grid-template-columns:auto auto;align-items:end;gap:12px}
    @media (min-width:420px){ .row{grid-template-columns:auto auto} }
    @media (min-width:640px){ .row{grid-template-columns:auto auto} }

    .field{display:flex;flex-direction:column;gap:6px}
    .ctrl{display:flex;align-items:center;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--panel)}
    .ctrl button{background:transparent;color:var(--text);border:0;padding:12px 14px;font-size:20px}
    .ctrl input{flex:1;background:var(--panel-2);color:var(--text);border:0;padding:12px 0;text-align:center;font-size:18px;min-width:0}

    .roll{width:100%;padding:18px;border-radius:var(--r-lg);background:var(--accent);color:#06241a;font-size:18px;font-weight:800;border:0;box-shadow:var(--shadow)}
    .roll:active{transform:translateY(1px)}

    .toggles{display:flex;align-items:center;justify-content:space-between;gap:10px;color:var(--muted);font-size:14px;flex-wrap:wrap}
    .toggles label{display:flex;align-items:center;gap:8px}

    .panel{border:1px solid var(--border);background:var(--panel);border-radius:var(--r-lg);padding:14px}
    .result-total{font-size:56px;font-weight:900;letter-spacing:-.02em}
    .result-sub{font-size:14px;color:var(--muted)}

    /* Make qty & mod blocks less wide */
    .field.compact{min-width:120px;max-width:160px}
    .field.compact .ctrl input{width:68px}

    .history{display:flex;flex-direction:column;gap:10px}
    .history-item{border:1px solid var(--border);background:var(--panel);border-radius:16px;padding:10px}
    .history-top{display:flex;align-items:center;justify-content:space-between}
    .chip{font-weight:800}
    .icon-btn{border:0;background:#0d1527;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:6px 8px;font-size:13px}

    /* Compact sizing for Qty & Modifier controls */
    #qtyMinus, #qtyPlus,
    #modMinus, #modPlus {
      padding: 8px 10px;
      font-size: 18px;
    }
    #qty, #mod {
      padding: 8px 0;
      font-size: 16px;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .roll-die { filter: drop-shadow(0 10px 24px rgba(0,0,0,.35)); }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <h1 class="title">Pathfinder Dice</h1>
      <button id="toggleDetails" class="icon-btn" aria-label="Переключить детали">Скрыть детали</button>
    </div>
  </header>

  <main>
    <!-- Dice selector -->
    <section>
      <div class="hint">Выберите кубик</div>
      <div class="dice-grid" id="diceGrid"></div>
      <div id="customWrap" class="ctrl" style="display:none;margin-top:10px;gap:10px;align-items:center">
        <button aria-hidden="true" tabindex="-1" style="opacity:.6">⚙</button>
        <input id="customSides" inputmode="numeric" pattern="[0-9]*" aria-label="Количество граней" value="3" />
      </div>
    </section>

    <!-- Quantity / Modifier -->
    <section class="row" aria-label="quantity and modifier">
      <div class="field compact">
        <div class="hint">Кубиков</div>
        <div class="ctrl">
          <button id="qtyMinus" aria-label="минус">−</button>
          <input id="qty" inputmode="numeric" pattern="[0-9]*" value="1" aria-label="Количество кубиков" />
          <button id="qtyPlus" aria-label="плюс">+</button>
        </div>
      </div>
      <div class="field compact">
        <div class="hint">Модификатор</div>
        <div class="ctrl">
          <button id="modMinus" aria-label="мод минус">−</button>
          <input id="mod" inputmode="numeric" value="0" aria-label="Модификатор" />
          <button id="modPlus" aria-label="мод плюс">+</button>
        </div>
      </div>
    </section>

    <!-- Roll & toggles -->
    <section>
      <button id="rollBtn" class="roll">Бросить</button>
    </section>

    <!-- Last result -->
    <section id="lastPanel" class="panel" style="display:none">
      <div class="hint">Последний результат</div>
      <div id="total" class="result-total">0</div>
      <div id="sub" class="result-sub"></div>
      <div id="rolls" class="result-sub" style="margin-top:6px"></div>
    </section>

    <!-- History -->
    <section>
      <div class="history-head" style="display:flex;align-items:center;justify-content:space-between">
        <div class="hint">История</div>
        <button id="btnClear" class="icon-btn" style="color:#94a3b8">Очистить</button>
      </div>
      <div id="history" class="history"></div>
    </section>

    <audio id="diceSound" src="the-dice-are-shuffled-and-thrown.mp3" preload="auto"></audio>
    <div id="rollingOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(11,18,32,.6);backdrop-filter:blur(2px);z-index:20">
      <svg id="rollingSVG" class="roll-die" viewBox="0 0 96 96" width="220" height="220" fill="none" stroke="currentColor" stroke-width="4" style="animation:spin 1s linear infinite;color:#e2e8f0"></svg>
    </div>
  </main>
</div>

<script>
(function(){
  'use strict';
  const DICE = [4,6,8,10,12,20,100];

  // STATE
  let state = { sides:20, custom:false, customSides:3, qty:1, mod:0, showDetails:true,
                explode:false, haptics:true, sound:true, shake:true, history:[], last:null };

  // ELEMENTS
  const diceGrid = document.getElementById('diceGrid');
  const customWrap = document.getElementById('customWrap');
  const customSides = document.getElementById('customSides');

  const qty = document.getElementById('qty');
  const qtyMinus = document.getElementById('qtyMinus');
  const qtyPlus = document.getElementById('qtyPlus');
  const mod = document.getElementById('mod');
  const modMinus = document.getElementById('modMinus');
  const modPlus = document.getElementById('modPlus');


  const toggleDetails = document.getElementById('toggleDetails');
  const lastPanel = document.getElementById('lastPanel');
  const totalEl = document.getElementById('total');
  const subEl = document.getElementById('sub');
  const rollsEl = document.getElementById('rolls');
  const btnClear = document.getElementById('btnClear');
  const historyEl = document.getElementById('history');

  // UTIL
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
  const randint = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;
  let vibSupported = 'vibrate' in navigator;
  const vibrate = (pattern=[20]) => {
    if (!state.haptics || !vibSupported) return;
    try {
      navigator.vibrate(pattern);
    } catch(e){
      vibSupported = false;
    }
  };
  const diceAudio = document.getElementById('diceSound');
  const playSound = () => {
    if (!diceAudio) return;
    try {
      diceAudio.pause();
      diceAudio.currentTime = 0;
      diceAudio.playbackRate = 1.0;
      diceAudio.volume = 0.75;
      diceAudio.play().catch(()=>{});
    } catch(e) {}
  };

  // Overlay helpers
  const overlay = document.getElementById('rollingOverlay');
  const rollingSVG = document.getElementById('rollingSVG');
  let rollingId = 0;
  let pendingResult = null;
  let rollNumTimer = null;
  let finalNumTimeout = null;

  const END_PAUSE_MS = 1000; // пауза после окончания звука, чтобы рассмотреть итог

  function polygonPoints(n, r=36, cx=48, cy=48) {
    const pts = [];
    for (let i=0;i<n;i++){
      const a = (Math.PI*2*i/n) - Math.PI/2;
      pts.push([cx + r*Math.cos(a), cy + r*Math.sin(a)]);
    }
    return pts.map(p=>p.join(',')).join(' ');
  }
  function setDieSVG(sides){
    let svg = '';
    if (sides === 100) {
      // draw a decagon to represent d100 visually
      svg = `<polygon points="${polygonPoints(10)}" />`;
    } else if (sides >= 3 && sides <= 32) {
      svg = `<polygon points="${polygonPoints(sides)}" />`;
    } else {
      svg = `<circle cx="48" cy="48" r="36" />`;
    }
    rollingSVG.innerHTML = svg;
  }

  function rollOne(sides){
    const seq=[randint(1, sides)];
    if(state.explode){
      while(seq[seq.length-1] === sides){ seq.push(randint(1, sides)); }
    }
    return seq;
  }

  function doRoll(){
    const sides = state.custom ? clamp(parseInt(customSides.value,10)||3,2,1000) : state.sides;
    const qtyN = clamp(parseInt(state.qty,10)||1,1,20);
    const modN = parseInt(state.mod,10)||0;

    let rollsFlat = [];
    let perDieChains = [];
    for(let i=0;i<qtyN;i++){
      const chain = rollOne(sides);
      perDieChains.push(chain);
      rollsFlat = rollsFlat.concat(chain);
    }

    const sum = rollsFlat.reduce((a,b)=>a+b,0);
    const total = sum + modN;

    const res = { ts: Date.now(), sides, qty: qtyN, mod: modN, rolls: rollsFlat, chains: perDieChains, sum, total, explode: state.explode };
    pendingResult = res;
    rollingId++;
    const myId = rollingId;
    showRolling(sides);
    vibrate([10,30,10]);
    playSound();
    // Schedule the final number to show just before sound ends
    const revealFinal = () => {
      const t = document.getElementById('rollingNum');
      if (t) t.textContent = String(res.total);
    };
    // If duration known, reveal 150ms before end; else fallback to 1200ms
    const durMs = (diceAudio && isFinite(diceAudio.duration) && diceAudio.duration > 0) ? diceAudio.duration * 1000 : 1200;
    const lead = 150; // ms before the end to lock the final value
    const delay = Math.max(0, durMs - lead);
    if (finalNumTimeout) { clearTimeout(finalNumTimeout); }
    finalNumTimeout = setTimeout(revealFinal, delay);

    diceAudio.onended = () => {
      if (myId !== rollingId) return;
      state.last = pendingResult;
      state.history = [state.last, ...state.history].slice(0,25);

      // Показать финальное число в дайсе
      const t = document.getElementById('rollingNum');
      if (t) t.textContent = String(state.last.total);

      // Остановить таймеры «мигания» цифр
      if (rollNumTimer) { clearInterval(rollNumTimer); rollNumTimer = null; }
      if (finalNumTimeout) { clearTimeout(finalNumTimeout); finalNumTimeout = null; }

      // Поставить на паузу вращение и дать пользователю 2 сек. рассмотреть грань
      try { rollingSVG.style.animationPlayState = 'paused'; } catch(e) {}

      setTimeout(() => {
        hideRolling();
        // восстановим состояние для следующего броска
        try { rollingSVG.style.animationPlayState = 'running'; } catch(e) {}
        renderLast(); renderHistory(); save();
      }, END_PAUSE_MS);
    };
  }

  function showRolling(sides){
    setDieSVG(sides);
    rollingSVG.style.animationPlayState = 'running';
    if (diceAudio && isFinite(diceAudio.duration) && diceAudio.duration>0) {
      rollingSVG.style.animationDuration = diceAudio.duration + 's';
    } else {
      rollingSVG.style.animationDuration = '1.5s';
    }
    if (rollNumTimer) { clearInterval(rollNumTimer); rollNumTimer = null; }
    if (finalNumTimeout) { clearTimeout(finalNumTimeout); finalNumTimeout = null; }
    rollNumTimer = setInterval(()=>{ const t = document.getElementById('rollingNum'); if (t) t.textContent = randint(1, sides); }, 100);
    overlay.style.display = 'flex';
  }
  function hideRolling(){
    overlay.style.display = 'none';
    if (rollNumTimer) { clearInterval(rollNumTimer); rollNumTimer = null; }
    if (finalNumTimeout) { clearTimeout(finalNumTimeout); finalNumTimeout = null; }
  }

  // PERSIST
  try{ const saved = JSON.parse(localStorage.getItem('pfr_dice_state')||'{}'); Object.assign(state, saved); }catch(e){}
  function save(){ try{ localStorage.setItem('pfr_dice_state', JSON.stringify({...state, history: state.history.slice(0,25)})); }catch(e){} }

  // BUILD DICE BUTTONS
  function buildDice(){
    diceGrid.innerHTML='';
    [...DICE, 'custom'].forEach(d=>{
      const b = document.createElement('button');
      b.className='btn'; b.textContent = d==='custom'? 'Свой' : ('d'+d); b.dataset.d = d;
      b.addEventListener('click', ()=>{
        if(d==='custom'){ state.custom=true; customWrap.style.display='flex'; }
        else { state.custom=false; state.sides=Number(d); customWrap.style.display='none'; }
        updateDiceActive(); save();
      });
      diceGrid.appendChild(b);
    });
    updateDiceActive();
  }
  function updateDiceActive(){
    document.querySelectorAll('#diceGrid .btn').forEach(b=>{
      const d=b.dataset.d; const isActive = (d==='custom' && state.custom) || (!state.custom && Number(d)===state.sides);
      b.classList.toggle('active', isActive);
    });
  }

  // INPUTS
  customSides.addEventListener('input', ()=>{ state.customSides = clamp(parseInt(customSides.value||'0',10)||3,2,1000); save(); });
  qtyMinus.addEventListener('click', ()=>{ qty.value = clamp((parseInt(qty.value,10)||1)-1,1,20); state.qty=Number(qty.value); save(); });
  qtyPlus.addEventListener('click', ()=>{ qty.value = clamp((parseInt(qty.value,10)||1)+1,1,20); state.qty=Number(qty.value); save(); });
  qty.addEventListener('input', ()=>{ state.qty = clamp(parseInt(qty.value||'1',10)||1,1,20); qty.value = state.qty; save(); });
  modMinus.addEventListener('click', ()=>{ state.mod=(parseInt(mod.value,10)||0)-1; mod.value=state.mod; save(); });
  modPlus.addEventListener('click', ()=>{ state.mod=(parseInt(mod.value,10)||0)+1; mod.value=state.mod; save(); });
  mod.addEventListener('input', ()=>{ state.mod = parseInt(mod.value||'0',10)||0; save(); });

  toggleDetails.addEventListener('click', ()=>{
    state.showDetails=!state.showDetails;
    toggleDetails.textContent = state.showDetails? 'Скрыть детали':'Показать детали';
    renderLast(); save();
  });

  // ROLLING

  function setDieSVG(sides){
    let svg = '';
    if (sides === 100) {
      svg = `<polygon points="${polygonPoints(10)}" />`;
    } else if (sides >= 3 && sides <= 32) {
      svg = `<polygon points="${polygonPoints(sides)}" />`;
    } else {
      svg = `<circle cx="48" cy="48" r="36" />`;
    }
    const text = `<text id="rollingNum" x="48" y="52" text-anchor="middle" dominant-baseline="middle" font-size="28" font-weight="600" fill="currentColor">?</text>`;
    rollingSVG.innerHTML = svg + text;
  }

  // RENDER
  function renderLast(){
    if(!state.last){ lastPanel.style.display='none'; return; }
    lastPanel.style.display='block';
    totalEl.textContent = state.last.total;
    subEl.textContent = `${state.last.qty}×d${state.last.sides}${state.last.mod? (state.last.mod>0? ' + '+state.last.mod : ' − '+Math.abs(state.last.mod)) : ''} → сумма ${state.last.sum}${state.last.explode?' (взрывные)':''}`;
    if(state.showDetails){
      const parts = state.last.chains.map(ch=> '['+ch.join('+')+']').join(', ');
      rollsEl.textContent = `Кости: ${parts}`;
    } else {
      rollsEl.textContent = '';
    }
  }

  function renderHistory(){
    historyEl.innerHTML='';
    state.history.forEach(h=>{
      const item = document.createElement('div'); item.className='history-item';
      const top = document.createElement('div'); top.className='history-top';
      const total = document.createElement('div'); total.className='chip'; total.textContent=h.total;
      top.append(total); item.append(top);
      if(state.showDetails){
        const d = document.createElement('div'); d.className='result-sub'; d.style.marginTop='6px';
        const chains = h.chains ? h.chains.map(ch=> '['+ch.join('+')+']').join(', ') : h.rolls.join(', ');
        d.textContent = `${h.qty}×d${h.sides}${h.mod? (h.mod>0? ' + '+h.mod : ' − '+Math.abs(h.mod)) : ''}${h.explode?' (взрывные)':''} → ${h.sum} — ${chains}`;
        item.append(d);
      }
      historyEl.append(item);
    });
  }

  // Shake to roll
  let lastAccel={x:null,y:null,z:null}, lastTime=0;
  window.addEventListener('devicemotion', (e)=>{
    const acc = e.accelerationIncludingGravity || e.acceleration; if(!acc) return;
    const now = Date.now(); if(now-lastTime<200) return; lastTime=now;
    if(lastAccel.x!==null){
      const delta = Math.abs(acc.x-lastAccel.x) + Math.abs(acc.y-lastAccel.y) + Math.abs(acc.z-lastAccel.z);
      if(delta>35) doRoll();
    }
    lastAccel={x:acc.x,y:acc.y,z:acc.z};
  }, {passive:true});

  // INIT
  function init(){
    qty.value = state.qty; mod.value = state.mod;
    toggleDetails.textContent = state.showDetails? 'Скрыть детали':'Показать детали';
    if(state.custom){ customWrap.style.display='flex'; customSides.value=state.customSides; } else { customWrap.style.display='none'; }
    buildDice(); renderLast(); renderHistory();
  }

  document.getElementById('rollBtn').addEventListener('click', doRoll);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') doRoll(); });

  btnClear.addEventListener('click', ()=>{ state.history=[]; renderHistory(); save(); });

  // No vibrate toggle warning needed anymore
  init();
})();
</script>
</body>
</html>
